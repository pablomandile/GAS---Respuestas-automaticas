/*************************************************************
*** PRIMER PROCESO QUE SE EJECUTA AL ABRIR LA PLANILLA     ***
*** VINCULADA CON EL EVENTO PARA SU FORMATEO               ***
*** Y AGREGAR UN CUSTOM MENU                               ***
*************************************************************/
function formateoPlanilla(){
  // Add a custom menu to the spreadsheet.
  SpreadsheetApp.getUi() // Or DocumentApp, SlidesApp, or FormApp.
      .createMenu('Menu CMKA')
      .addItem('Recordatorio de Pago', 'menuItem1')
      .addItem('Envío Links a Confirmados', 'BibRespuestaAuto.envioLinksAConfirmados')
      .addToUi();
  var ActiveSheet = SpreadsheetApp.getActiveSheet();
  var ActiveCol = ActiveSheet.getLastColumn();
  var sheet = ActiveSheet.getDataRange().getValues();
  var colTemporal = "";
  colTemporal = sheet[0].indexOf('Asistencia')+1;  
  if (colTemporal == 0){
    var MaxCols = ActiveSheet.getMaxColumns();
    for (var i = 0; i < MaxCols; i++){
      ActiveSheet.autoResizeColumn(i+1);
      ActiveSheet.getRange(1, i+1).setBackground('#CFE2F3');
    }
    ActiveSheet.insertColumnAfter(ActiveCol);
    ActiveSheet.getRange(1, ActiveCol+1).setValue('Pendiente').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+1);
    ActiveSheet.getRange(1, ActiveCol+2).setValue('Respuesta').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+2);
    ActiveSheet.getRange(1, ActiveCol+3).setValue('Envio Info TKS').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+3);
    ActiveSheet.getRange(1, ActiveCol+4).setValue('Membresía').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+4);
    ActiveSheet.getRange(1, ActiveCol+5).setValue('Links Youtube').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+5);
    ActiveSheet.getRange(1, ActiveCol+6).setValue('Pago').setBackground('#faa16e');
    ActiveSheet.insertColumnAfter(ActiveCol+6);
    ActiveSheet.getRange(1, ActiveCol+7).setValue('Recordatorio pago').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+7);
    ActiveSheet.getRange(1, ActiveCol+8).setValue('Confirmación').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+8);
    ActiveSheet.getRange(1, ActiveCol+9).setValue('NombreEvento').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+9);
    ActiveSheet.getRange(1, ActiveCol+10).setValue('DatosEvento').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+10);
    ActiveSheet.getRange(1, ActiveCol+11).setValue('Programa').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+11);
    ActiveSheet.getRange(1, ActiveCol+12).setValue('FechaPago').setBackground('#CFE2F3');
    MaxCols = ActiveSheet.getMaxColumns();
    ActiveSheet.insertColumnAfter(ActiveCol+12);
    ActiveSheet.getRange(1, ActiveCol+13).setValue('Valor').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+13);
    ActiveSheet.getRange(1, ActiveCol+14).setValue('Forma').setBackground('#CFE2F3');
    ActiveSheet.insertColumnAfter(ActiveCol+14);
    ActiveSheet.getRange(1, ActiveCol+15).setValue('Asistencia').setBackground('#CFE2F3');
    for (var i = 0; i < MaxCols; i++){
      ActiveSheet.autoResizeColumn(i+1);
    }
  }
    SpreadsheetApp.flush();
}

/*************************************************************
*** FUNCIÓN PRINCIPAL DE PRECESO DE LOS DATOS ENVIADOS     ***
*** DESDE EL FORMULARIO DE REGISTRO                        ***
*** CALCÚLA QUE PREGUTAS VIENEN EN EL FORMULARIO           ***
*** TOMA TODOS LOS DATOS QUE CONTESTO EL CLIENTE DE LA     ***
*** PLANILLA DE RESPUESTAS                                 ***
*** CALCULA SI ES 2X1 Y TODOS LOS DESCUENTOS SEGÚN TK      ***
*** LLAMA A TODAS LAS DEMÁS FUNCIONES                      ***
*** ESCRIBE EL ESTADO EN LA PLANILLA, PENDIENTE Y ENVIOS   ***
*************************************************************/
function procesoRespuestas(e, TituloEvento){
  var ActiveSheet = SpreadsheetApp.getActiveSheet();
  var ActiveRow = ActiveSheet.getLastRow();
  var sheet = ActiveSheet.getDataRange().getValues();
  var Preguntas = {
            infoTKAB : '¿TE GUSTARÍA RECIBIR MÁS INFORMACIÓN PARA OBTENER TU TARJETA KADAMPA?',
            pais : '¿De qué país eres?',
            modalidad : '¿Bajo que modalidad vas a participar?',
            nombre : 'Nombre',
            nombreAdulto : 'Nombre y apellido del Adulto que acompañara al niñ@',
            apellido : 'Apellido',
            mail : 'Dirección de correo electrónico',
            mailTK : 'Dirección de correo electrónico TK',
            invitadoNombre : 'NOMBRE Y APELLIDO DEL INVITADO/A',
            tarjetasyabono: '¿TENÉS ALGUNA DE NUESTRAS TARJETAS KADAMPAS?',
            invitadoMail : 'Dirección de correo electrónico INVITADO/A',
            grabaciones: '¿Te gustaría adquirir las GRABACIONES de las enseñanzas recibidas durante el evento?',
            eventoPorDias : 'PODÉS SUMARTE AL RETIRO COMPLETO O POR DÍA. Por favor, seleccioná la opción que elegiste:',
            eventoPorUnDia : 'PODÉS SUMARTE AL EVENTO COMPLETO O POR DÍA. Por favor, seleccioná la opción que elegiste:',
            diasAParticipar: 'SELECCIONA QUE DIA/S PARTICIPARÁS'
  }
  var Nombre = "";
  var Apellido = "";
  var mail = "";
  var completarDatos = false;
  var infoTKAbono = (buscoColumna(Preguntas.infoTKAB,sheet) != 0) ? valorPlanilla(Preguntas.infoTKAB) : "";
  var Pais = (buscoColumna(Preguntas.pais,sheet) != 0) ? valorPlanilla(Preguntas.pais) : "ARGENTINA";
  var ModalidadElegida = (buscoColumna(Preguntas.modalidad,sheet) != 0) ? valorPlanilla(Preguntas.modalidad) : "PRESENCIAL";
  Nombre = (buscoColumna(Preguntas.nombre,sheet) != 0) ? valorPlanilla(Preguntas.nombre) : "";
  if (Nombre == "") {
    Nombre = (buscoColumna(Preguntas.nombreAdulto,sheet) != 0) ? valorPlanilla(Preguntas.nombreAdulto) : "";
  };
  Apellido = (buscoColumna(Preguntas.apellido,sheet) != 0) ? valorPlanilla(Preguntas.apellido) : "";
  mail = (buscoColumna(Preguntas.mail,sheet) != 0) ? valorPlanilla(Preguntas.mail) : "";
  if (mail == ""){
    mail = (buscoColumna(Preguntas.mail,sheet) != 0) ? valorPlanilla(Preguntas.mailTK) : "";
    completarDatos = true;
  }
  var grabaciones = (buscoColumna(Preguntas.grabaciones,sheet) != 0) ? valorPlanilla(Preguntas.grabaciones) : "";
  //quito espacios de los ingresos de usuario
  Nombre = Nombre.trim();
  Apellido = Apellido.trim();
  mail = mail.trim().toLowerCase();

  var TipoTKyAbono = (buscoColumna(Preguntas.tarjetasyabono,sheet) != 0) ? valorPlanilla(Preguntas.tarjetasyabono) : "VALOR UNICO";
  var eventoPorDias = (buscoColumna(Preguntas.eventoPorDias,sheet) != 0) ? valorPlanilla(Preguntas.eventoPorDias) : "";
  var eventoPorUnDia = (buscoColumna(Preguntas.eventoPorUnDia,sheet) != 0) ? valorPlanilla(Preguntas.eventoPorUnDia) : "";
  var diasAParticipar = (buscoColumna(Preguntas.diasAParticipar,sheet) != 0) ? valorPlanilla(Preguntas.diasAParticipar) : "";

  /* FUNCIONES DE BUSQUEDA DE DATOS EN PLANILLA INFORMACIÓN DE CURSOS
      DESDE LA HOJA CRSOS Y MAILINFO */
  var datosEvento = buscaCurso(TituloEvento, Pais);
  var datosMail = CargoDatosMail();    
  /* FUNCIONES DE BUSQUEDA DE DATOS EN PLANILLA INFORMACIÓN DE CURSOS
      DESDE LA HOJA CRSOS Y MAILINFO */

  datosEvento.NombreUsuario = Nombre;
  datosEvento.ApellidoUsuario = Apellido;
  datosEvento.MailUsuario = mail;

  if (datosEvento.Tipo == "Clase día del Amigo 2x1"){
    var claseInvitacion = {
      invitadoNombre : (buscoColumna(Preguntas.invitadoNombre,sheet) != 0) ? valorPlanilla(Preguntas.invitadoNombre) : "",
      invitadoMail : (buscoColumna(Preguntas.invitadoMail,sheet) != 0) ? valorPlanilla(Preguntas.invitadoMail) : "",
      invitadoSubject : "REGALO - " + datosEvento.Asunto
    }
  } else {
    var claseInvitacion = {
      invitadoNombre : "",
      invitadoMail : "",
      invitadoSubject : ""
    }
  }
  var chequeoTKS = true;
  
  //SI ES UN RETIRO DE VARIOS DÍAS ADMITE PAGO POR DÍA
  if (eventoPorDias != ""){
    switch (eventoPorDias)  {
      // RETIROS COMPRENDIDOS ENTRE LOS DIAS VIERNES A MARTES
      case 'VOY A PARTICIPAR POR DIA':
          chequeoTKS = false;
          datosEvento.LinkYoutube = '';
          datosEvento.LinkYoutubePrograma = "";
          datosEvento.diasAParticipar = diasAParticipar;
          var diasSemana = ['VIERNES', 'SABADO', 'DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES'];
          diasSemana.forEach(function DIASEVENTO(dia){
            if(datosEvento.diasAParticipar.indexOf(dia) != -1){
              linkDia = 'LinkYoutubeDia' + dia;
              datosEvento.LinkYoutubeDias += datosEvento[linkDia];
              datosEvento.cantDiasElegidos += 1;
            }
          });
          if (datosEvento.cantDiasElegidos == 1){
            datosEvento.aPagar = datosEvento.Valor1Dia;
            datosEvento.botonPago = datosEvento.BotondePago1Dia;
            datosEvento.textoInscPorDia = "<br>Te inscribiste para participar del día " + datosEvento.diasAParticipar + "<br>";
          } else if (datosEvento.cantDiasElegidos == 2){
            datosEvento.aPagar = (datosEvento.Valor1Dia * 2);
            datosEvento.botonPago = datosEvento.BotondePago2Dias;
            var dias = "";
            dias = diasAParticipar;
            var diasSinEspacio = dias.split(', ');
            dias = diasSinEspacio.join(' y ');
            datosEvento.textoInscPorDia = "<br>Te inscribiste para participar de los días " + dias + "<br>";
          }
      break; 
      default:
      break;
    }
  }

  if(TipoTKyAbono == 'SI, TENGO TARJETA KADAMPA'){
    var tieneTK = chequeoTkActiva(mail, datosMail, datosEvento, TipoTKyAbono, Pais);
      } else if(Pais == 'Uruguay'){
          tieneTK = 'SIN MEMBRESIA-UY';
        } else{
            tieneTK = 'SIN MEMBRESIA';
  }
  if (chequeoTKS){
    switch (tieneTK)  {
      case 'TK CLASES (Antes llamada ABONO MENSUAL)':
      // NO HAY DESCUENTO POR TK CLASES - VALOR GENERAL
        datosEvento.aPagar = (datosEvento.ValorAbono != "") ? datosEvento.ValorAbono : "0";
        datosEvento.botonPago = datosEvento.BotondePagoAbono;
        if(eventoPorUnDia == 'VOY A PARTICIPAR DEL EVENTO COMPLETO'){
          datosEvento.textoInscPorDia = "<br>Te inscribiste para participar del evento completo.<br>";
        }
      break;
      case 'TK CORAZÓN':
        if(eventoPorUnDia == 'VOY A PARTICIPAR POR DIA'){
            datosEvento.aPagar = (datosEvento.Valor1DiaTKCOR != "") ? datosEvento.Valor1DiaTKCOR : "0";
            datosEvento.botonPago = datosEvento.BotondePago1DiaTKCOR;
            datosEvento.textoInscPorDia = "<br>Te inscribiste para participar un día<br>";
            celebracionIniciacionSabado();
        } else{
            datosEvento.aPagar = (datosEvento.ValorTKCorazon != "") ? datosEvento.ValorTKCorazon : "0";
            datosEvento.botonPago = datosEvento.BotondePagoTKCorazon;
            if(eventoPorUnDia == 'VOY A PARTICIPAR DEL EVENTO COMPLETO'){
               datosEvento.textoInscPorDia = "<br>Te inscribiste para participar del evento completo.<br>";
            } 
        }
      break; 
      case 'TK BENEFACTOR':
        if(eventoPorUnDia == 'VOY A PARTICIPAR POR DIA'){
            datosEvento.aPagar = (datosEvento.Valor1DiaTKBEN != "") ? datosEvento.Valor1DiaTKBEN : "0";
            datosEvento.botonPago = datosEvento.BotondePago1DiaTKBEN;
            datosEvento.textoInscPorDia = "<br>Te inscribiste para participar un día<br>";
            celebracionIniciacionSabado();
        } else{
            datosEvento.aPagar = (datosEvento.ValorTKBenefactor != "") ? datosEvento.ValorTKBenefactor : "0";
            datosEvento.botonPago = datosEvento.BotondePagoTKBenefactor;
            if(eventoPorUnDia == 'VOY A PARTICIPAR DEL EVENTO COMPLETO'){
               datosEvento.textoInscPorDia = "<br>Te inscribiste para participar del evento completo.<br>";
            } 
        }
      break; 
      case 'TK CORAZÓN-UY':
        if(eventoPorUnDia == 'VOY A PARTICIPAR POR DIA'){
            datosEvento.aPagar = (datosEvento.ValorDol1DiaTKCOR != "") ? datosEvento.ValorDol1DiaTKCOR : "0";
            datosEvento.botonPago = datosEvento.BotonPagoDolT1DiaKCOR;
            datosEvento.ValorEvento = datosEvento.ValorDolares;
            datosEvento.Moneda = "USD";
            datosMail.TextoInicial += datosMail.infoPagoPaypal;
            datosEvento.textoInscPorDia = "<br>Te inscribiste para participar un día<br>";
            celebracionIniciacionSabado();
        } else{
            datosEvento.aPagar = (datosEvento.ValorDolTKCOR != "") ? datosEvento.ValorDolTKCOR : "0";
            datosEvento.botonPago = datosEvento.BotonPagoDolTKCOR;
            datosEvento.ValorEvento = datosEvento.ValorDolares;
            datosEvento.Moneda = "USD";
            datosMail.TextoInicial += datosMail.infoPagoPaypal;
            if(eventoPorUnDia == 'VOY A PARTICIPAR DEL EVENTO COMPLETO'){
               datosEvento.textoInscPorDia = "<br>Te inscribiste para participar del evento completo.<br>";
            } 
        }
      break; 
        case 'TK BENEFACTOR-UY':
        if(eventoPorUnDia == 'VOY A PARTICIPAR POR DIA'){
            datosEvento.aPagar = (datosEvento.ValorDol1Dia != "") ? datosEvento.ValorDol1Dia : "0";
            datosEvento.botonPago = datosEvento.BotonPagoDolares1Dia;
            datosEvento.ValorEvento = datosEvento.ValorDolares;
            datosEvento.Moneda = "USD";
            datosMail.TextoInicial += datosMail.infoPagoPaypal;
            datosEvento.textoInscPorDia = "<br>Te inscribiste para participar un día<br>";
            celebracionIniciacionSabado();
        } else{
            datosEvento.aPagar = (datosEvento.ValorDolares != "") ? datosEvento.ValorDolares : "0";
            datosEvento.botonPago = datosEvento.BotonPagoDolares;
            datosEvento.ValorEvento = datosEvento.ValorDolares;
            datosEvento.Moneda = "USD";
            datosMail.TextoInicial += datosMail.infoPagoPaypal;
            if(eventoPorUnDia == 'VOY A PARTICIPAR DEL EVENTO COMPLETO'){
               datosEvento.textoInscPorDia = "<br>Te inscribiste para participar del evento completo.<br>";
            } 
        }
      break; 
      case 'SIN MEMBRESIA':
            datosEvento.aPagar = datosEvento.ValorEvento;
      break;
      case 'SIN MEMBRESIA-UY':
        if(eventoPorUnDia == 'VOY A PARTICIPAR POR DIA'){
            datosEvento.ValorEvento = datosEvento.ValorDolares;
            datosEvento.Moneda = "USD";
            datosMail.TextoInicial += datosMail.infoPagoPaypal;
            datosEvento.aPagar = (datosEvento.ValorDol1Dia != "") ? datosEvento.ValorDol1Dia : "0";
            datosEvento.botonPago = datosEvento.BotonPagoDolares1Dia;
            datosEvento.textoInscPorDia = "<br>Te inscribiste para participar un día<br>";
            celebracionIniciacionSabado();
        } else{
            datosEvento.ValorEvento = datosEvento.ValorDolares;
            datosEvento.Moneda = "USD";
            datosEvento.aPagar = datosEvento.ValorEvento;
            datosMail.TextoInicial += datosMail.infoPagoPaypal;
            datosEvento.botonPago = datosEvento.BotonPagoDolares;
            if(eventoPorUnDia == 'VOY A PARTICIPAR DEL EVENTO COMPLETO'){
               datosEvento.textoInscPorDia = "<br>Te inscribiste para participar del evento completo.<br>";
            } 
        }
      break;
      default:
      break;
    }  
  }
  function celebracionIniciacionSabado(){
    if(datosEvento.Tipo = "Celebración"){
              datosEvento.LinkYoutubePrograma = "";
              datosEvento.LinkYoutube = datosEvento.LinkYoutubeDiaSABADO;
    }
  }

  if (datosEvento.Tipo == "Preceptos"){
    datosEvento = Preceptos(datosMail, datosEvento, TituloEvento);
  } else{
    datosEvento = ArmoPago(datosEvento, datosMail);
    datosEvento.infoAcceso = datosMail[verificarModalidad(ModalidadElegida, datosEvento)];
  }
  if (grabaciones == 'Sí, quiero reservar las grabaciones'){
    if (Pais == 'Argentina'){
      grabaciones = "<br><strong>Grabaciones del evento: " + datosEvento.Moneda + datosEvento.ValorGrabaciones + "</strong>" +
        "<br><a href='"+ datosEvento.BotonPagoGrabaciones + 
        "'><img src='https://meditarenargentina.org/wp-content/uploads/2021/12/btnabonar.png' height='59' width='319'></a>"
    } else{
      grabaciones = "<br><strong>Grabaciones del evento: " + datosEvento.Moneda + datosEvento.ValorGrabacionesDol + "</strong>" +
        "<br><a href='"+ datosEvento.BotonPagoDolGrabaciones + 
        "'><img src='https://meditarenargentina.org/wp-content/uploads/2021/12/btnabonar.png' height='59' width='319'></a>"
    }
  } else {
    grabaciones = "";
  }
  ArmoMailyEnvio(datosEvento, datosMail, TituloEvento, claseInvitacion, ActiveSheet, ActiveRow, sheet, tieneTK, grabaciones, ModalidadElegida);

  if (infoTKAbono == "SI, me gustaría!"){
    envioInfoTKyAbono(datosMail, sheet, ActiveSheet, ActiveRow, Nombre, Apellido, mail);
  }
  if(completarDatos){
    ActiveSheet.getRange(ActiveRow, buscoColumna('Nombre',sheet)).setValue(datosEvento.NombreUsuario);
    ActiveSheet.getRange(ActiveRow, buscoColumna('Apellido',sheet)).setValue(datosEvento.ApellidoUsuario);
    ActiveSheet.getRange(ActiveRow, buscoColumna('Dirección de correo electrónico',sheet)).setValue(datosEvento.MailUsuario);
    ActiveSheet.getRange(ActiveRow, buscoColumna('Teléfono celular',sheet)).setValue(datosEvento.TelefonoUsuario);
  }
  ActiveSheet.getRange(ActiveRow, buscoColumna('Pendiente',sheet)).setValue(datosEvento.Moneda + 
  datosEvento.aPagar).setHorizontalAlignment('right');
  ActiveSheet.getRange(ActiveRow, buscoColumna('Respuesta',sheet)).setValue("ENVIADA").setBackground('#67ad63').setFontColor('white');
  ActiveSheet.getRange(ActiveRow, 1).setBackground('#b3d1ff');
  SpreadsheetApp.flush();
  function valorPlanilla(valCampo){
      return ActiveSheet.getRange(ActiveRow, buscoColumna(valCampo,sheet)).getValue()
  }
  /*************************************************************
  *** DETERMINO CUÁL ES EL PAIS PARA SABER QUÉ MONEDA Y      ***
  *** TIPO DE PAGO USAR                                      ***
  *************************************************************/
  // function determinoPaisPago(Pais, datosEvento, datosMail){
  //   if (Pais == "URUGUAY"){
  //     datosEvento.ValorEvento = datosEvento.ValorDolares;
  //     datosEvento.Moneda = "US";
  //     datosMail.TextoInicial += datosMail.infoPagoPaypal;
  //     return datosEvento.BotonPagoDolares;
  //   }
  //   return datosEvento.botonPago;
  // }
}
  /*************************************************************
  ***              FIN CÓDIGO FUNCIÓN PRINCIPAL              ***
  ***                                                        ***
  *************************************************************/

/*************************************************************
*** CHEQUEA LA FECHA PARA SABER SI ESTÁ ACTIVO EL FORM     ***
*** O DEBE DESACTIVARLO                                    ***
*************************************************************/
function desactivarFormenFecha(i, infoFechaCierre){
  var DiaActual = new Date();
  var FechaCierre = new Date(infoFechaCierre);
  if (DiaActual.getTime() >= FechaCierre.getTime()){
      var AS = SpreadsheetApp.getActiveSheet();
      var NombreFormActivo = AS.getFormUrl()
      var Form = FormApp.openByUrl(NombreFormActivo);
      Form.setAcceptingResponses(false);
    }
}

/*************************************************************
*** TRAE TODOS LOS DATOS PARA CONFORMAR EL EMAIL DE        ***
*** RESPUESTA DESDE LA PLANILLA INFORMACIÓN DE CURSOS /    ***
*** MAILINFO MÁS LO PROCESADO EN PROCESO RESPUESTAS        ***
*************************************************************/
function CargoDatosMail(){
  var ss = SpreadsheetApp.openById("1zVvWhDAfTVPZUkXxnb5qntpkRSWTDT8KoSF7QZYlRwE");
  var sheetDatosMail = ss.getSheetByName('MailInfo');
  var DM = sheetDatosMail.getDataRange().getValues();

  //Retorno resultados en array associativo
      var infMail = {
        TextoInicial:valorPlanilla('TextoInicial'),
        TextoInicialConfirmado:valorPlanilla('TextoInicialConfirmado'), 
        infoAccesoOnline:valorPlanilla('infoAccesoOnline'),
        infoAccesoPresencial:valorPlanilla('infoAccesoPresencial'),
        infoAccesoPresencialSinLink:valorPlanilla('infoAccesoPresencialSinLink'),
        infoAccesoOnlineLINK:valorPlanilla('infoAccesoOnlineLINK'),
        infoAccesoMeditacionChicos:valorPlanilla('infoAccesoMeditacionChicos'),
        Saludo:valorPlanilla('Saludo'),
        Dudas:valorPlanilla('Dudas'),
        PagoTransfer:valorPlanilla('pagoTransfer'),
        infoAccesoPreceptos:valorPlanilla('Preceptos'),
        envioInfoTK:valorPlanilla('envioInfoTK'),
        infoPagoPaypal:valorPlanilla('infoPagoPaypal'),
        errorEnMembresia1:valorPlanilla('errorEnMembresia1'),
        errorEnMembresia2:valorPlanilla('errorEnMembresia2')
      };
    return infMail;
    function valorPlanilla(valCampo){
      return sheetDatosMail.getRange(2, buscoColumna(valCampo,DM)).getValue()
    }
}

/*************************************************************
*** SEGÚN EL NOMBRE DEL CURSO INGRESADO, LO BUSCA EN       ***
*** INFORMACIÓN DE CURSOS / CURSOS Y TRAE TODOS LOS DATOS  ***
*** CALCÚLA SI TIENE FECHA DE EXPIRACIÓN EL FORMULARIO     ***
*** CALCÚLA SI ESTÁ O NO EN FECHA DE DESCUENTO POR PAGO    ***
*** ADELANTADO                                             ***
*************************************************************/
function buscaCurso(TituloEvento, Pais){
  var ss = SpreadsheetApp.openById("1zVvWhDAfTVPZUkXxnb5qntpkRSWTDT8KoSF7QZYlRwE");
  var sheetDatosCursos = ss.getSheetByName("Cursos");
  var DC = sheetDatosCursos.getDataRange().getValues();

  var datos = sheetDatosCursos.getRange(2, 1, sheetDatosCursos.getLastRow(),sheetDatosCursos.getLastColumn()).getValues();
  for(var i = 0;i<datos.length; i++){
    if(datos[i][0] == TituloEvento ){
      i=i+2;
      var infoFechaCierre = valorPlanilla('infoFechaCierre');
      if (infoFechaCierre != "") {
        desactivarFormenFecha(i, infoFechaCierre);
      }
      var ValorEvento = valorPlanilla('ValorGeneral');
      var ValorTKCorazon = valorPlanilla('ValorTKCorazon');
      var ValorTKBenefactor = valorPlanilla('ValorTKBenefactor');
      var SinDescuentoTKC = valorPlanilla('SinDescuentoTKC');
      var SinDescuentoTKB = valorPlanilla('SinDescuentoTKB');
      var SinDescuentoG = valorPlanilla('SinDescuentoG');
      var SinDescuentoAb = valorPlanilla('SinDescuentoTKClases');
      var ValorAbono = valorPlanilla('ValorTKClases');
      var ValorDolares = valorPlanilla('ValorDolares');
      var SinDescuentoDol = valorPlanilla('SinDescuentoDol');
      var ValorDolTKCOR = valorPlanilla('ValorDolTKCOR');
      var SinDescuentoDolTKCOR = valorPlanilla('SinDescuentoDolTKCOR');
      var infoPrograma = valorPlanilla('Programa');
      var infoFechaDescuento = valorPlanilla('Precio desc anticipado');
      if (infoFechaDescuento != "") {
        var DiaActual = new Date();
        var FechaCierre = new Date(infoFechaDescuento);
        if (DiaActual.getTime() >= FechaCierre.getTime()){
            if (SinDescuentoG != ""){
                ValorEvento = SinDescuentoG;
            }
            if (SinDescuentoTKC != ""){
              ValorTKCorazon = SinDescuentoTKC;
            }
            if (SinDescuentoTKB != ""){
              ValorTKBenefactor = SinDescuentoTKB;
            }
            if (SinDescuentoAb != ""){
                ValorAbono = SinDescuentoAb;
            }
            if (Pais == "URUGUAY"){
              ValorDolares = SinDescuentoDol;
              ValorDolTKCOR = SinDescuentoDolTKCOR;
            }
        }
      }

      //RETORNO VALORES EN OBJETO
      var infCurso = {
        ValorEvento:ValorEvento, 
        aPagar:ValorEvento, 
        Asunto:valorPlanilla('Tipo') + " " + valorPlanilla('Fecha') + " " + valorPlanilla('Hora') + " - " + TituloEvento,
        subject:"",
        FechaEvento:valorPlanilla('Fecha'), 
        HoraEvento:valorPlanilla('Hora'), 
        Tipo:valorPlanilla('Tipo'),
        Disponibilidad:valorPlanilla('Disponibilidad'), 
        LugarEvento:valorPlanilla('Lugar'),
        Modalidad:valorPlanilla('Modalidad'),
        NombreUsuario: "",
        ApellidoUsuario: "",
        MailUsuario:"",
        TelefonoUsuario:"",
        ValorAbono:ValorAbono,
        ValorTKCorazon:ValorTKCorazon,
        ValorTKBenefactor:ValorTKBenefactor,
        Valor1Dia:valorPlanilla('Valor1Dia'),
        Valor1DiaTKCOR:valorPlanilla('Valor1DiaTKCOR'),
        Valor1DiaTKBEN:valorPlanilla('Valor1DiaTKBEN'),
        ValorDol1Dia: valorPlanilla('ValorDol1Dia'),
        ValorDol1DiaTKCOR:valorPlanilla('ValorDol1DiaTKCOR'),
        ValorDolares:ValorDolares,
        ValorDolTKCOR:ValorDolTKCOR,
        ValorGrabaciones:valorPlanilla('ValorGrabaciones'),
        ValorGrabacionesDol:valorPlanilla('ValorGrabacionesDol'),
        botonPago:valorPlanilla('BotondePago'),
        BotondePago1Dia:valorPlanilla('BotondePago1Dia'),
        BotondePago2Dias:valorPlanilla('BotondePago2Dias'),
        BotondePago1DiaTKCOR:valorPlanilla('BotondePago1DiaTKCOR'),
        BotondePago1DiaTKBEN:valorPlanilla('BotondePago1DiaTKBEN'),
        BotondePagoTKCorazon:valorPlanilla('BotondePagoTKCorazon'),
        BotondePagoTKBenefactor:valorPlanilla('BotondePagoTKBenefactor'),
        BotondePagoAbono:valorPlanilla('BotondePagoTKClases'),
        BotonPagoDolares: valorPlanilla('BotonPagoDolares'),
        BotonPagoDolares1Dia:valorPlanilla('BotonPagoDolares1Dia'),
        BotonPagoDolTKCOR:valorPlanilla('BotonPagoDolTKCOR'),
        BotonPagoDolT1DiaKCOR:valorPlanilla('BotonPagoDolT1DiaKCOR'),
        BotonPagoGrabaciones:valorPlanilla('BotonPagoGrabaciones'),
        BotonPagoDolGrabaciones:valorPlanilla('BotonPagoDolGrabaciones'),
        LineasDePago:"",
        TextoInicial:"",
        infoAcceso:"",
        pagoTransfer:"",
        infoPrograma:infoPrograma,
        diasAParticipar : "",
        cantDiasElegidos : 0,
        textoInscPorDia : "",
        textoErrorMembresia: "",
        LinkYoutube: valorPlanilla('LinkYoutube'),
        LinkYoutubePrograma: valorPlanilla('LinkYoutube Programa'),
        LinkYoutubeDias:"",
        LinkYoutubeDiaVIERNES:valorPlanilla('LinkYoutube DiaViernes'),
        LinkYoutubeDiaSABADO:valorPlanilla('LinkYoutube DiaSabado'),
        LinkYoutubeDiaDOMINGO:valorPlanilla('LinkYoutube DiaDomingo'),
        LinkYoutubeDiaLUNES:valorPlanilla('LinkYoutube DiaLunes'),
        LinkYoutubeDiaMARTES:valorPlanilla('LinkYoutube DiaMartes'),
        TextoLink:"<strong>LINK DE ACCESO: </strong>",
        AvisoOnline:"<br><br><strong>La clase se activará el " + 
                    valorPlanilla('Fecha') + " " + valorPlanilla('Hora') + "</strong><br>",
        Moneda:"$"
      };
    return infCurso;
    }
  }
  function valorPlanilla(valCampo){
      return sheetDatosCursos.getRange(i, buscoColumna(valCampo,DC)).getValue();
  }
}

/*************************************************************
*** TOMA TODOS LOS DATOS DEL CLIENTE Y CONFORMA EL         ***
*** CUERPO, ASUNTO Y ENCABEZADO DEL MAIL EN HTML           ***
*** CALCÚLA SI HAY VARIOS LINKS DE VIDEOS Y LOS SEPARA     ***
*** CALCÚLA SI HAY INVITADOS Y LES ENVÍA OTRO MAIL         ***
*************************************************************/
function ArmoMailyEnvio(datosEvento, datosMail, TituloEvento, claseInvitacion, ActiveSheet, ActiveRow, sheet, tieneTK, grabaciones, ModalidadElegida){
  var styleF28 = "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:28px;line-height:36px;color:#3c4043'>";
  var styleF28White = "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:28px;line-height:36px;color:#ffffff'>";
  var styleF22 = "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:22px;line-height:36px;color:#3c4043'>";
  var styleF18 = "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:18px;line-height:36px;color:#3c4043'>";
  var styleF18Blue = "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:18px;line-height:36px;color:#4575ec'>";
  var styleF22Tab = "<span style='margin-left:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:22px;line-height:36px;color:#3c4043'>";
  var styleF22Morado = "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:22px;line-height:36px;color:#a66cf5'>";
  var finStyle = "</span>";
    // emailBody is for those devices that can't render HTML, is plain text
  var emailBody = "¡Hola! " + "\nGracias por tu inscripción al Curso " + TituloEvento + "\nen fecha " +
        "\nPróximamente recibirás un email con más detalles sobre éste evento y tu información de pago." + "\nMuchas Gracias";
  
  // Armado de información del evento
  var encabezadoMail = "<table width='720' border='0' align='center' bgcolor='white' cellpadding='0' cellspacing='0'>"+
        "<tr bgcolor='#2784d6'><td><img src='https://meditarenargentina.org/wp-content/uploads/2021/12/Header-Social4.png' alt='Social Media' width='720' usemap='#m_-6367196319079066917_Redes' title='CMKA Social' border='0' style='display:block'>"+
            "<map name='m_-6367196319079066917_Redes' id='m_-6367196319079066917Redes'>"+
            "<area shape='rect' coords='01,01,90,70'  href='https://www.facebook.com/meditarenargentina' alt='Facebook CMKA' target='_blank'>"+
            "<area shape='rect' coords='92,01,188,70' href='https://www.instagram.com/meditarenargentina/' alt='Instagram CMKA' target='_blank'>"+
            "<area shape='rect' coords='190,01,303,70' href='https://www.youtube.com/channel/UC8Bmrclk97g2onCsWRwZCyw' alt='Youtube CMKA' target='_blank'>"+
            "<area shape='rect' coords='306,01,410,70' href='https://open.spotify.com/artist/0SKgzlnrfGPaeQfUUgDhb7/discography/album' alt='Spotify' target='_blank'>"+
            "<area shape='rect' coords='412,01,512,70' href='https://api.whatsapp.com/send?phone=541161495976' alt='Whatsapp' target='_blank'>"+
            "<area shape='rect' coords='515,01,616,70' href='https://twitter.com/meditarenarg' alt='Twitter CMKA' target='_blank'>"+
            "<area shape='rect' coords='618,01,720,70' href='https://meditarenargentina.org/' alt='web Centro de meditación KadampaArgentina' target='_blank'>"+
            "</map></td></tr><tr bgcolor='#fff'><td><img src='https://meditarenargentina.org/wp-content/uploads/2021/12/Header-720x253-1.png' width='720' style='display:block' alt='Banner Header'>"+
            "</td></tr><tr><td valign='middle' style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:28px;line-height:36px;color:#3c4043'>";
  var inicioPieMail = "</td></tr><tr height='150px' bgcolor='#4575ec'><td align='center' valign='middle' style='padding:0px 18px 40px 18px;'>" + styleF28White + datosMail.Saludo + finStyle ;
  var finPieMail ="</td></tr><tr bgcolor='#fff'><td align='center' style='padding:20px 18px'> <a href='https://meditarenargentina.org/' target='blank'><img src='https://meditarenargentina.org/mailKadampa/logo_Centro.png' alt='Logo CMKA' width='200' border='0'></a></td></tr></table>";

  var DatosEvento = styleF22 + "<br/><strong>DETALLES DEL EVENTO: </strong>" + finStyle +
    styleF18 + "<br/>Nombre del evento: " + finStyle + styleF18Blue + "<strong>" + TituloEvento + "</strong>" + finStyle +
    styleF18 + "<br/>Fecha y hora: " + datosEvento.FechaEvento + " " + datosEvento.HoraEvento + finStyle +
    styleF18 + "<br/>Disponible por: " + datosEvento.Disponibilidad + finStyle +
    styleF18 + "<br/>Lugar: " + finStyle + styleF18Blue + "<strong>" + datosEvento.LugarEvento + "</strong>" + finStyle;
  
  var saludoInicial = styleF28 + "¡Hola " + '<strong>' + datosEvento.NombreUsuario + " " + datosEvento.ApellidoUsuario + "</strong>!" + finStyle;

  if(datosEvento.LinkYoutubeDias != ""){
    datosEvento.LinkYoutube = datosEvento.LinkYoutubeDias;
    datosEvento.LinkYoutubePrograma = "";
  }else if(datosEvento.LinkYoutubePrograma != ""){
    datosEvento.LinkYoutube = datosEvento.LinkYoutubePrograma;
  }else if(datosEvento.Tipo != "Celebración") {
    separoLinksYoutube();
  }

  if (datosEvento.aPagar > 0){    
    if(datosEvento.Modalidad == "PRESENCIALMENTE"){
      datosEvento.LinkYoutube = "";
      datosEvento.infoAcceso = datosMail.infoAccesoPresencialSinLink;
    }
    ActiveSheet.getRange(ActiveRow, buscoColumna('Membresía',sheet)).setValue(tieneTK);
    ActiveSheet.getRange(ActiveRow, buscoColumna('Links Youtube',sheet)).setValue(datosEvento.LinkYoutube);
    ActiveSheet.getRange(ActiveRow, buscoColumna('Pago',sheet)).setValue('CH');
    var nombreEvento = ActiveSheet.getRange(2, buscoColumna('NombreEvento',sheet)).getValue();
    var datosPlanillaEventoOnl = ActiveSheet.getRange(2, buscoColumna('DatosEvento',sheet)).getValue();
    var datosPlanillaEventoPre = ActiveSheet.getRange(3, buscoColumna('DatosEvento',sheet)).getValue();
    var planillaPrograma = ActiveSheet.getRange(2, buscoColumna('Programa',sheet)).getValue();
    if (nombreEvento == ""){
      ActiveSheet.getRange(2, buscoColumna('NombreEvento',sheet)).setValue(TituloEvento);
    }
    if (datosPlanillaEventoOnl == ""){
      if(ModalidadElegida == "ONLINE"){
        ActiveSheet.getRange(2, buscoColumna('DatosEvento',sheet)).setValue(DatosEvento);
      }
    }
    if (datosPlanillaEventoPre == ""){
      if(ModalidadElegida == "PRESENCIAL"){
        ActiveSheet.getRange(3, buscoColumna('DatosEvento',sheet)).setValue(DatosEvento);
      }
    } 
    if (planillaPrograma == ""){
      ActiveSheet.getRange(2, buscoColumna('Programa',sheet)).setValue(datosEvento.infoPrograma);
    }
    datosEvento.TextoLink = "";
    datosEvento.AvisoOnline = "";
    datosEvento.LinkYoutube = "";
  }else{
    ActiveSheet.getRange(ActiveRow, buscoColumna('Membresía',sheet)).setValue(tieneTK);
    ActiveSheet.getRange(ActiveRow, buscoColumna('Pago',sheet)).setValue('NO');
    if(datosEvento.Modalidad == "PRESENCIALMENTE"){
    datosEvento.TextoLink = "";
    datosEvento.AvisoOnline = "";
    datosEvento.LinkYoutube = "";
    datosEvento.infoAcceso = datosEvento.infoAccesoPresencialSinLink;
    }
  }
  var htmlBody =  encabezadoMail + saludoInicial + styleF22 + datosEvento.TextoInicial + finStyle + 
    styleF22Tab + 'Membresía: ' + finStyle + styleF22Morado + tieneTK + '<br>' + finStyle +
    styleF22Morado + datosEvento.textoInscPorDia + finStyle + styleF22Tab + datosEvento.LineasDePago + finStyle + 
    styleF22 + datosEvento.textoErrorMembresia + finStyle + styleF22Tab + grabaciones + finStyle +
    styleF22 + datosEvento.pagoTransfer + finStyle + 
    DatosEvento + styleF18 + datosEvento.infoPrograma + finStyle + styleF18 + datosEvento.infoAcceso + finStyle + styleF18 + 
    datosEvento.TextoLink + finStyle + 
    styleF18Blue + datosEvento.LinkYoutube + finStyle + styleF22Morado + datosEvento.AvisoOnline + finStyle +
    styleF18 + datosMail.Dudas + finStyle + inicioPieMail + finPieMail;

  // More info for Advanced Options Parameters 
  // https://developers.google.com/apps-script/reference/mail/mail-app#sendEmail(String,String,String,Object)
  var advancedOpts = { name: "Inscripciones - CMKA", htmlBody: htmlBody};
  MailApp.sendEmail(datosEvento.MailUsuario, datosEvento.subject, emailBody, advancedOpts);

  if (claseInvitacion.invitadoNombre != "" && datosEvento.aPagar == 0){
    var htmlBodyinvitado =  encabezadoMail + "¡Hola " + "<strong>" +
    claseInvitacion.invitadoNombre + "</strong>" + "!" + "<br/><br/>Te contamos que " 
    + datosEvento.NombreUsuario + " " + datosEvento.ApellidoUsuario + " te invitó a una clase de meditación <br/>" + 
    " por el día del amigo! <br/>" + "<br/><br/><strong>INFORMACIÓN IMPORTANTE: </strong><br/>" +
    DatosEvento + datosEvento.infoAcceso  + datosEvento.TextoLink + datosEvento.LinkYoutube +
    datosEvento.AvisoOnline + datosMail.Dudas + inicioPieMail + datosMail.Saludo + finPieMail;
    var advancedOpts = { name: "Inscripciones - CMKA", htmlBody: htmlBodyinvitado};
    MailApp.sendEmail(claseInvitacion.invitadoMail, claseInvitacion.invitadoSubject, emailBody, advancedOpts);
    ActiveSheet.getRange(ActiveRow, buscoColumna('Dirección de correo electrónico INVITADO/A',sheet)).setBackground('green').setFontColor('white');
  }
  
  // SI HAY MÁS DE UN VÍNCULO DE YOUTUBE LOS SEPARO EN PARTES CON SUS VÍNCULOS
  function separoLinksYoutube(){
    var vinculosYoutube = datosEvento.LinkYoutube.split(";");
    if (vinculosYoutube.length > 1) {
      datosEvento.LinkYoutube = "";
      vinculosYoutube.forEach( function(indice) {
        if(vinculosYoutube[indice] != ""){
          datosEvento.LinkYoutube += "<P><strong> Sesión " + (indice+1) +
                                      ": </strong><a href='" + vinculosYoutube[indice] + "'>" + 
                                      vinculosYoutube[indice] + "</a></p>";
        }
      });
    } else{
      datosEvento.LinkYoutube = "<a href='" + datosEvento.LinkYoutube + "'>" + datosEvento.LinkYoutube + "</a>";
    }
  }
}

/*************************************************************
*** ARMA LOS DATOS DE PAGO SEGÚN TK                        ***
*** SI TIENE EL EVENTO INCLIÚDO LE CONFIRMA LA INSCRIPCIÓN ***
*** Y LE MUESTRA LOS LINKS DE YOUTUBE                      ***
*************************************************************/
function ArmoPago(datosEvento, datosMail){
  if (datosEvento['aPagar'] > 0 ){
    datosEvento['TextoInicial'] = datosMail['TextoInicial'];
    var LineaPago1 = "<br><strong>El valor del evento: " + datosEvento.Moneda + datosEvento['aPagar'] + "</strong>";
    var LineaPago2 = "<br><a href='"+ datosEvento.botonPago +
    "'><img src='https://meditarenargentina.org/wp-content/uploads/2021/12/btnabonar.png' height='59' width='319'></a>"
    datosEvento['LineasDePago'] = LineaPago1 + LineaPago2;
    datosEvento.subject = "¿Confirmaste tu inscripción a " + datosEvento.Asunto + "?";
    datosEvento.pagoTransfer = datosMail.PagoTransfer;
  } else {
      datosEvento['TextoInicial'] = datosMail['TextoInicialConfirmado'];
      datosEvento['LineasDePago'] =  "";
      datosEvento.subject = datosEvento.Asunto + " - Inscripción confirmada";
      datosEvento.pagoTransfer = "";
  }
return datosEvento;
}
/*************************************************************
*** VERIFICA SI EL EVENTO ES TOMA DE PRECEPTOS             ***
*** PARA INCLUIR INFO EXTRA EN EL MAIL Y NO CALCULAR COSTO ***
*************************************************************/
function Preceptos(datosMail, datosEvento, TituloEvento){
    datosEvento['infoAcceso'] = datosMail.infoAccesoPreceptos;
    datosEvento['lineas de pago'] = "";
    datosEvento.textoErrorMembresia = "";
    datosEvento['subject'] = datosEvento.FechaEvento +" " + datosEvento.HoraEvento +" " + TituloEvento + " - " + "Inscripción confirmada";
    datosEvento['TextoInicial'] = datosMail['TextoInicialConfirmado'];
  return datosEvento;
}

/*************************************************************
*** VERIFICA LA MODALIDAD ELEGIDA DEL EVENTO: ONLINE       ***
*** O PRESENCIAL E INCLUYE INFO DE PROTOCOLO               ***
*************************************************************/
function verificarModalidad(ModalidadElegida, datosEvento){
  // Verificar si la modalidad es presencial u online para cambiar el texto de infoAcceso
  var infoAcceso = "";
  switch (ModalidadElegida)  {
    case "PRESENCIAL":
      infoAcceso = "infoAccesoPresencial";
      /*datosEvento.LinkYoutube = "";     ****QUEDA DESHABILITADO PORQUE AHORA SE ENVÍAN LOS  
        datosEvento.TextoLink = "";           LINKS DE YOUTUBE AUNQUE ELIJA IR PRESENCIAL****
        datosEvento.AvisoOnline = "";*/
      datosEvento.LugarEvento = "Serrano 1316, PALERMO";
    break;
    case "ONLINE":
      if (datosEvento.aPagar == 0){
      infoAcceso = "infoAccesoOnlineLINK";
      } else {
        if(datosEvento.Tipo == "Meditación para Niños"){
          infoAcceso = "infoAccesoMeditacionChicos";
          datosEvento.TextoLink = "";
          datosEvento.AvisoOnline = "";
        } else{
          infoAcceso = "infoAccesoOnline";
          datosEvento.TextoLink = "";
          datosEvento.AvisoOnline = "";
        }
      }
      datosEvento.LugarEvento = "ONLINE";
    break; 
    default:
      infoAcceso = "infoAccesoOnline";
    break;
  }  
  return infoAcceso;
}

/*************************************************************
*** AHORRA CÓDIGO EN CADA FUNCIÓN DÓNDE TRAE DATOS DE      ***
*** LA PLANILLA INFORMACIÓN DE CURSOS                      ***
*************************************************************/
function buscoColumna(Campo, sheet){
      columna = sheet[0].indexOf(Campo)+1;
      return columna;
}

/**************************************************************
*** SI EL CLIENTE ELIGE RECIBIR INFORMACIÓN EXTRA SOBRE LOS ***
*** BENEFICIOS DE LAS TKS SE LE ENVÍA UN MAIL ADICIONAL     ***
**************************************************************/
function envioInfoTKyAbono(datosMail, sheet, ActiveSheet, ActiveRow, Nombre, Apellido, mail){
  var saludoInfo = "<br/>Espero que estés muy bien.<br/><br/>Muchas gracias por tu interés en nuestras actividades.<br/>";  
  subject = "Información solicitada sobre Tarjetas Kadampa";
  var LineaInscripcionTK = datosMail.envioInfoTK;
  envioMail(Nombre, Apellido, saludoInfo, LineaInscripcionTK, mail, subject);

  function envioMail(Nombre, Apellido, saludoInfo, LineaInscripcionTK, mail, subject){
    var emailBody ="";
    var htmlBody =  "¡Hola <font color=\"green\"><strong>" + Nombre + " " + Apellido + "</strong></font>" + "!" + saludoInfo +
    LineaInscripcionTK + datosMail.Saludo;
    var advancedOpts = { name: "INFORMACIÓN - CMKA", htmlBody: htmlBody};
    MailApp.sendEmail(mail, subject, emailBody, advancedOpts);
  }
  colTemporal = sheet[0].indexOf('Envio Info TKS')+1;  
  ActiveSheet.getRange(ActiveRow, colTemporal).setValue("ENVIADA").setBackground('#67ad63').setFontColor('white');
}

/**************************************************************
*** CHEQUEA EN BASE A LA ELECCIÓN DE MEMBRESÍA DE USUARIO   ***
*** SI ESTÁ ACTIVA CONSULTANDO PLANILLA TKS PAGOS POR AÑO   ***
**************************************************************/
function chequeoTkActiva(correo, datosMail, datosEvento, TipoTKyAbono, Pais){
  var correoPlanilla = "";
  var membresiaTK = '';
  var tkPais = "";
  var ss = SpreadsheetApp.openById('10K7j0GEVjHX2BcKXHEsCgpE7LKtCZbZzvNVgQEshDZk');
  var sheetDatosTKCMKA = ss.getSheetByName("2022");
  var datosTKCMKA = sheetDatosTKCMKA.getRange(3, 1, sheetDatosTKCMKA.getLastRow(),9).getValues();
  var ss2 = SpreadsheetApp.openById('1glxhF229H3fuWPrpzExpPX1YPcXhGrY1-mBw8TfToMk');
  var sheetDatosTKZN = ss2.getSheetByName('TK 2022');
  var datosTKZN = sheetDatosTKZN.getRange(3, 1, sheetDatosTKZN.getLastRow(), 9).getValues();

  if (Pais == 'Uruguay'){
    tkPais = '-UY';
  }

  buscoPlanillaCMKA();

  function buscoPlanillaCMKA(){
    for(var i = 0;i<datosTKCMKA.length; i++){
      correoPlanilla = datosTKCMKA[i][6].toString();
      correoPlanilla = correoPlanilla.trim();
      if(correoPlanilla == correo){
        datosEvento.NombreUsuario = datosTKCMKA[i][1];
        datosEvento.ApellidoUsuario = datosTKCMKA[i][2];
        datosEvento.MailUsuario = correoPlanilla;
        datosEvento.TelefonoUsuario = datosTKCMKA[i][7];
        if(datosTKCMKA[i][3] == 'A' ){
          switch (datosTKCMKA[i][4]){
            case 'CLA':
                  membresiaTK = 'TK CLASES (Antes llamada ABONO MENSUAL)' + tkPais;
            break;
            case 'COR':
                  membresiaTK = 'TK CORAZÓN' + tkPais;
            break;
            case 'BEN':
                  membresiaTK = 'TK BENEFACTOR' + tkPais;
            break;
            default:
              membresiaTK = 'SIN MEMBRESIA' + tkPais;
            break;
          }
        } else {
          membresiaTK = 'SIN MEMBRESIA' + tkPais;
        }
      } 
   }
   if (membresiaTK == 'SIN MEMBRESIA'){
     buscoPlanillaZN();
   }
  }

  function buscoPlanillaZN(){
    for(var i = 0;i<datosTKZN.length; i++){
      correoPlanilla = datosTKZN[i][7].toString();
      correoPlanilla = correoPlanilla.trim();
      if(correoPlanilla == correo){
        datosEvento.NombreUsuario = datosTKZN[i][1];
        datosEvento.ApellidoUsuario = datosTKZN[i][2];
        datosEvento.MailUsuario = correoPlanilla;
        datosEvento.TelefonoUsuario = datosTKZN[i][6];
        if(datosTKZN[i][3] == 'A' ){
          switch (datosTKZN[i][4]){
            case 'CLA':
                  membresiaTK = 'TK CLASES (Antes llamada ABONO MENSUAL)';
            break;
            case 'COR':
                  membresiaTK = 'TK CORAZÓN';
            break;
            case 'BEN':
                  membresiaTK = 'TK BENEFACTOR';
            break;
            default:
              membresiaTK = 'SIN MEMBRESIA';
            break;
          }
        } else {
          membresiaTK = 'SIN MEMBRESIA';
        }
      } 
    }
  }

  if (membresiaTK == ""){
    membresiaTK = 'SIN MEMBRESIA' + tkPais;
  }
  if (membresiaTK == 'SIN MEMBRESIA'){
    datosEvento.textoErrorMembresia = datosMail.errorEnMembresia1 + '<strong>' + TipoTKyAbono + '</strong>' + datosMail.errorEnMembresia2;
  }
  return membresiaTK;
}
/**************************************************************
*** ENVIO MAIL CON LINKS DE YOUTUBE UNA VEZ CONFIRMADO      ***
*** EL PAGO EN LA COLUMNA PAGO CON UN OK                    ***
**************************************************************/
function envioLinksAConfirmados(){
  var e = estilos();
  var textoAcceso = "";
  var datosInscripcion = {};
  var datosMail = {};
  var partesMail = {};
  var htmlBody = "";
  var saludoInicial = "";
  var correos = 0;
  var ActiveSheet = SpreadsheetApp.getActiveSheet();
  var sheet = ActiveSheet.getDataRange().getValues();
  var inscripcion = ActiveSheet.getRange(1, 1, ActiveSheet.getLastRow(),ActiveSheet.getLastColumn()).getValues();
  var tituloEvento = ActiveSheet.getRange(2, buscoColumna('NombreEvento', sheet)).getValue();
  var datosEventoOnline = ActiveSheet.getRange(2, buscoColumna('DatosEvento', sheet)).getValue();
  var datosEventoPresencial = ActiveSheet.getRange(3, buscoColumna('DatosEvento', sheet)).getValue();
  var datosEvento = "";
  var programa = ActiveSheet.getRange(2, buscoColumna('Programa', sheet)).getValue();
  var asunto = 'CONFIRMACIÓN: inscripción a "' + tituloEvento + '" y links de acceso.';
  var pendiente = inscripcion[0].indexOf('Pendiente');  
  var pago = inscripcion[0].indexOf('Pago'); 
  var confirmacion = inscripcion[0].indexOf('Confirmación');
  // var ui = SpreadsheetApp.getUi(); 
  var avisoOnline = "<br><br><strong>La clase se activará el día del evento a la hora de inicio</strong><br>";
  Confirmacion();

  function Confirmacion(){
    var response = Browser.msgBox('ENVÍO DE MAILS A CONFIRMADOS', 'Seguro que quiere continuar?', Browser.Buttons.YES_NO); 
    if ( response == "yes"){
      var correosEnviados = recorroPlanilla();
      if(correosEnviados > 0){
        Browser.msgBox('ENVÍO DE MAILS A CONFIRMADOS', 'La acción ha sido realizada con éxito. Correos enviados: '+ correosEnviados, Browser.Buttons.OK); 
      } else{
        Browser.msgBox('ENVÍO DE MAILS A CONFIRMADOS', 'No hay correos a enviar', Browser.Buttons.OK); 
      }
      // var mensaje = '<p>La acción ha sido realizada con éxito.</p> <p>Correos enviados: '+ correosEnviados + '</p>';
      // var msg = HtmlService.createHtmlOutput(mensaje)
      //       .setSandboxMode(HtmlService.SandboxMode.IFRAME)
      //       .setWidth(150)
      //       .setHeight(200);
      // ui .showModalDialog(msg, 'ENVÍO DE MAILS A CONFIRMADOS',).Buttons.OK;
    }
  }

  function recorroPlanilla(){
    var textoPago = '';
    for(var i = 0;i<inscripcion.length; i++){
      if(i > 0){
        if(inscripcion[i][pendiente] == 0){
          textoPago = (inscripcion[i][pago]).toString().trim().toUpperCase();
          if(textoPago == 'OK'){
            if(inscripcion[i][confirmacion] == ''){
              datosInscripcion = traigoDatosParticipante(i);
              datosMail = CargoDatosMail();
              textoAcceso = chModalidad();
              partesMail = encabezadoyPieMail(datosMail);
              saludoInicial = e.styleF28 + "¡Hola " + '<strong>' + datosInscripcion.nombre  + " " + 
                              datosInscripcion.apellido + "</strong>!" + e.finStyle;
              htmlBody = partesMail.encabezadoMail + saludoInicial + e.styleF22 + datosMail.TextoInicialConfirmado + e.finStyle + 
                          e.styleF22Tab + 'Membresía: ' + e.finStyle + e.styleF22Morado + datosInscripcion.membresia + e.finStyle + '<br>' +
                          e.styleF18 + datosInscripcion.completoDia + datosInscripcion.completoDiaRetiro +
                          " " + datosInscripcion.diasQueParticipa + datosInscripcion.introduccion + e.finStyle + 
                          datosEvento + e.styleF18 + programa + e.finStyle + e.styleF18 + textoAcceso + e.finStyle + 
                          e.styleF18Blue + datosInscripcion.linksYoutube + e.finStyle + e.styleF22Morado + avisoOnline + e.finStyle +
                          e.styleF18 + datosMail.Dudas + e.finStyle + partesMail.pieMail;
              envioMail(htmlBody, datosInscripcion.mail, asunto);
              
              ActiveSheet.getRange(i+1, buscoColumna('Confirmación', sheet)).setValue('ENVIADA').setBackground('#67ad63').setFontColor('white');
              correos += 1;
            }
          }
        }
      }
    }
    return correos;
  }

  function chModalidad(){
    var acceso = '';
    if(datosInscripcion.modalidad == 'ONLINE'){
        acceso = datosMail.infoAccesoOnlineLINK;
        datosEvento = datosEventoOnline;
    } else if(datosInscripcion.modalidad == 'PRESENCIAL'){
        acceso = datosMail.infoAccesoPresencial;
        datosEvento = datosEventoPresencial;
    }
    return acceso;
  }
//¿PARTICIPARÁS DE LA INTRODUCCIÓN EL VIERNES? (GRATIS)
  function traigoDatosParticipante(index){
    index = index + 1 ;
    var inscripcion = {
      nombre: (buscoColumna('Nombre',sheet) != 0) ? valorPlanilla('Nombre', index) : "",
      apellido: (buscoColumna('Apellido',sheet) != 0) ? valorPlanilla('Apellido', index) : "",
      modalidad: (buscoColumna('¿Bajo que modalidad vas a participar?',sheet) != 0) ? valorPlanilla('¿Bajo que modalidad vas a participar?', index) : "",
      mail: (buscoColumna('Dirección de correo electrónico',sheet) != 0) ? valorPlanilla('Dirección de correo electrónico', index) : "",
      membresia: (buscoColumna('Membresía',sheet) != 0) ? valorPlanilla('Membresía', index) : "",
      linksYoutube: (buscoColumna('Links Youtube',sheet) != 0) ? valorPlanilla('Links Youtube', index) : "",
      introduccion: (buscoColumna('¿PARTICIPARÁS DE LA INTRODUCCIÓN EL VIERNES? (GRATIS)',sheet) != 0) ? valorPlanilla('¿PARTICIPARÁS DE LA INTRODUCCIÓN EL VIERNES? (GRATIS)', index) : "",
      completoDia: (buscoColumna('PODÉS SUMARTE AL EVENTO COMPLETO O POR DÍA. Por favor, seleccioná la opción que elegiste:',sheet) != 0) ? valorPlanilla('PODÉS SUMARTE AL EVENTO COMPLETO O POR DÍA. Por favor, seleccioná la opción que elegiste:', index) : "",
      completoDiaRetiro: (buscoColumna('PODÉS SUMARTE AL RETIRO COMPLETO O POR DÍA. Por favor, seleccioná la opción que elegiste:',sheet) != 0) ? valorPlanilla('PODÉS SUMARTE AL RETIRO COMPLETO O POR DÍA. Por favor, seleccioná la opción que elegiste:', index) : "",
      
      diasQueParticipa: (buscoColumna('SELECCIONA QUE DIA/S PARTICIPARÁS',sheet) != 0) ? valorPlanilla('SELECCIONA QUE DIA/S PARTICIPARÁS', index) : "",
    };
    if(inscripcion.completoDia != ""){
      inscripcion.completoDia = '<br>Tu inscripción: ' + inscripcion.completoDia;
    }else if(inscripcion.completoDiaRetiro != ""){
      inscripcion.completoDiaRetiro = '<br>Tu inscripción: ' + inscripcion.completoDiaRetiro;
    }
    if(inscripcion.diasQueParticipa != ""){
      inscripcion.diasQueParticipa = ': ' + inscripcion.diasQueParticipa;
    }
    if(inscripcion.introduccion != ""){
      inscripcion.introduccion = ' + INTRODUCCIÓN VIERNES <br>';
    } else{
      inscripcion.introduccion = '<br>';
    }
    
    return inscripcion;
}
   

  function valorPlanilla(valCampo, i){
    return ActiveSheet.getRange(i, buscoColumna(valCampo, sheet)).getValue();
  }

  function envioMail(htmlBody, mail, asunto){
    var emailBody = "";
  // https://developers.google.com/apps-script/reference/mail/mail-app#sendEmail(String,String,String,Object)
  var advancedOpts = { name: "Inscripciones - CMKA", htmlBody: htmlBody};
  MailApp.sendEmail(mail, asunto, emailBody, advancedOpts);
  }
}

/**************************************************************
*** ARMO UN OBJETO CON ESTILOS PARA USAR EN EL HTML         ***
*** DEL CUERPO DE LOS EMAILS                                ***
**************************************************************/
function estilos(){
  var estilos = {
        styleF28: "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:28px;line-height:36px;color:#3c4043'>",
        styleF28White: "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:28px;line-height:36px;color:#ffffff'>",
        styleF22: "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:22px;line-height:36px;color:#3c4043'>",
        styleF18: "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:18px;line-height:36px;color:#3c4043'>",
        styleF18Blue: "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:18px;line-height:36px;color:#4575ec'>",
        styleF22Tab: "<span style='margin-left:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:22px;line-height:36px;color:#3c4043'>",
        styleF22Morado: "<span style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:22px;line-height:36px;color:#a66cf5'>",
        finStyle: "</span>",
  }
  return estilos;
}

/**************************************************************
*** ARMO UN ENCABEZADO Y UN PIE PARA LOS EMAILS             ***
***                                                         ***
**************************************************************/
function encabezadoyPieMail(datosMail){
  var e = estilos();
  var partesMail = {
      encabezadoMail: "<table width='720' border='0' align='center' bgcolor='white' cellpadding='0' cellspacing='0'>"+
        "<tr bgcolor='#2784d6'><td><img src='https://meditarenargentina.org/wp-content/uploads/2021/12/Header-Social4.png' alt='Social Media' width='720' usemap='#m_-6367196319079066917_Redes' title='CMKA Social' border='0' style='display:block'>"+
            "<map name='m_-6367196319079066917_Redes' id='m_-6367196319079066917Redes'>"+
            "<area shape='rect' coords='01,01,90,70'  href='https://www.facebook.com/meditarenargentina' alt='Facebook CMKA' target='_blank'>"+
            "<area shape='rect' coords='92,01,188,70' href='https://www.instagram.com/meditarenargentina/' alt='Instagram CMKA' target='_blank'>"+
            "<area shape='rect' coords='190,01,303,70' href='https://www.youtube.com/channel/UC8Bmrclk97g2onCsWRwZCyw' alt='Youtube CMKA' target='_blank'>"+
            "<area shape='rect' coords='306,01,410,70' href='https://open.spotify.com/artist/0SKgzlnrfGPaeQfUUgDhb7/discography/album' alt='Spotify' target='_blank'>"+
            "<area shape='rect' coords='412,01,512,70' href='https://api.whatsapp.com/send?phone=541161495976' alt='Whatsapp' target='_blank'>"+
            "<area shape='rect' coords='515,01,616,70' href='https://twitter.com/meditarenarg' alt='Twitter CMKA' target='_blank'>"+
            "<area shape='rect' coords='618,01,720,70' href='https://meditarenargentina.org/' alt='web Centro de meditación KadampaArgentina' target='_blank'>"+
            "</map></td></tr><tr bgcolor='#fff'><td><img src='https://meditarenargentina.org/wp-content/uploads/2021/12/Header-720x253-1.png' width='720' style='display:block' alt='Banner Header'>"+
            "</td></tr><tr><td valign='middle' style='margin-bottom:32px;font-family:Google Sans,Roboto,Arial,Helvetica,sans-serif;font-style:normal;font-size:28px;line-height:36px;color:#3c4043'>",
      pieMail: "</td></tr><tr height='150px' bgcolor='#4575ec'><td align='center' valign='middle' style='padding:0px 18px 40px 18px;'>" + 
      e.styleF28White + datosMail.Saludo + e.finStyle + "</td></tr><tr bgcolor='#fff'><td align='center' style='padding:20px 18px'> <a href='https://meditarenargentina.org/' target='blank'><img src='https://meditarenargentina.org/mailKadampa/logo_Centro.png' alt='Logo CMKA' width='200' border='0'></a></td></tr></table>",
  }
  return partesMail;
}
/**************************************************************
*** AGREGAR EL SIGUIENTE BLOQUE DE CÓDIGO EN EL APPS SCRIPT ***
*** DE CADA FORMULARIO NUEVO DENTRO DE SU SHEET ASOCIADA ******
***                 INICIO DE CÓDIGO                        ***
*** var TituloEvento = "Introducción al tantra";            ***
*** function onOpen(e) {BibRespuestaAuto.formateoPlanilla();} *
*** function emailOnFormSubmit(e) {                         ***
*** BibRespuestaAuto.procesoRespuestas(e, TituloEvento);    ***
***                   FIN DE CÓDIGO                         ***
*** IMPORTANTE: Cambiar sólo el título del evento           ***
*** Ejemplo: var TituloEvento = "Karma y Vacuidad";         ***
**************************************************************/
